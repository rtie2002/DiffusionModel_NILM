# 扩散模型训练与采样策略

## 1. 负载曲线的概率建模

本扩散模型的目标是学习条件分布 $p_\theta(x_0 | c)$，其中 $x_0 \in \mathbb{R}^{L \times 1}$ 表示长度为 $L$ 的家电功率消耗序列，$c \in \mathbb{R}^{L \times K}$ 表示对应的时间条件特征（例如：一天中的时间、星期几、季节指标）。模型被训练以生成符合人类活动潜在时间模式的真实功率曲线。

### 1.1 训练阶段：随机切片学习

在训练阶段，批次之间不需要严格的时间连续性。模型通过最大化数据集随机切片上的证据下界（ELBO）来学习局部依赖关系和条件关系。

设 $\mathcal{D} = \{(x^{(i)}, c^{(i)})\}_{i=1}^{T_{total}}$ 为完整的时间序列数据集，其中 $T_{total}$ 是记录的时间戳总数。我们定义滑动窗口操作 $\mathcal{W}_j$，从索引 $j$ 开始提取长度为 $L$ 的子序列：
$$
\mathbf{x}_j = \mathcal{W}_j(\mathcal{D}) = \{x^{(j)}, \dots, x^{(j+L-1)}\}
$$
$$
\mathbf{c}_j = \mathcal{W}_j(\mathcal{C}) = \{c^{(j)}, \dots, c^{(j+L-1)}\}
$$

训练目标是最小化简化的噪声预测损失：
$$
\mathcal{L}_{\text{simple}} = \mathbb{E}_{j \sim U(0, T_{total}-L), t \sim U(1, T), \epsilon \sim \mathcal{N}(0, I)} \left[ \| \epsilon - \epsilon_\theta(\sqrt{\bar{\alpha}_t}\mathbf{x}_j + \sqrt{1-\bar{\alpha}_t}\epsilon, t, \mathbf{c}_j) \|^2 \right]
$$

关键在于，起始索引 $j$ 在每一步都从整个数据集中均匀采样。这种**随机切片学习**确保：
1.  **独立同分布（IID）假设近似**：通过将每个窗口 $\mathbf{x}_j$ 视为独立样本，我们满足了稳定随机梯度下降（SGD）所需的独立同分布假设。
2.  **时间偏差消除**：由于 DataLoader 的 `shuffle=True` 设置，虽然单个 batch 可能不包含所有时间上下文，但在每个 **epoch** 内，模型会遍历整个数据集的所有样本（包括所有季节、所有星期、所有时段）。随着多个 epoch 的训练且每次 shuffle 顺序不同，模型以近似相等的频率接触所有时间上下文（例如：早晨/傍晚、夏季/冬季），从而防止对任何特定时期的过拟合。

## 2. 采样阶段：条件生成策略

模型 $p_\theta(x_0 | c)$ 训练完成后，可用于合成数据。合成数据的质量和实用性在很大程度上取决于如何选择条件 $\mathbf{c}$。我们提出两种不同的采样策略：**有序非重叠采样**（用于训练数据增强）和**随机采样**（用于多样性增强）。

### 2.1 策略 A：随机条件采样

在此模式下，我们旨在从学习到的分布中生成多样化、有代表性的样本，而不强制执行长期连续性。我们从数据集中均匀采样 $N$ 个索引 $\{j_1, \dots, j_N\}$：
$$
j_k \sim U(0, T_{total}-L)
$$

合成数据批次 $X_{sf}$ 生成为：
$$
X_{sf} = \{ \hat{\mathbf{x}}_{j_1}, \dots, \hat{\mathbf{x}}_{j_N} \} \quad \text{其中} \quad \hat{\mathbf{x}}_{j_k} \sim p_\theta(x_0 | \mathbf{c}_{j_k})
$$

**特性：**
*   **分布匹配**：此策略确保合成数据集中时间条件的边际分布与真实分布 $p(\mathbf{c})$ 匹配。例如，如果"12月"占真实数据的 1/12，它也将占合成条件的 ~1/12。
*   **多样性**：适合观察模型在各种随机条件下的行为。

### 2.2 策略 B：有序非重叠采样（数据集复制）

为了创建在结构上镜像真实数据集的合成数据集（例如，用于训练下游 NILM 模型），我们采用**有序非重叠**策略。我们将时间条件 $\mathcal{C}$ 划分为 $M$ 个长度为 $L$ 的连续、非重叠块：
$$
M = \lfloor T_{total} / L \rfloor
$$
起始索引是确定性的，以 $L$ 为步长：
$$
J = \{0, L, 2L, \dots, (M-1)L\}
$$

合成数据集 $\mathcal{D}_{syn}$ 通过顺序生成每个块的功率曲线来构建：
$$
\mathcal{D}_{syn} = \bigcup_{k=0}^{M-1} \hat{\mathbf{x}}_{k \cdot L} \quad \text{其中} \quad \hat{\mathbf{x}}_{k \cdot L} \sim p_\theta(x_0 | \mathbf{c}_{k \cdot L})
$$

**数学含义：**
这实际上是对整个记录历史的**重新模拟**。
$$
\hat{X}_{total} \approx \int p_\theta(x_t | c_t) \, dt \quad \text{在域 } [0, T_{total}] \text{ 上}
$$
这确保：
1.  **完整的时间覆盖**：原始数据集中的每个时间戳 $c^{(i)}$ 都被用作条件，且仅使用一次。
2.  **季节完整性**：合成数据包含与真实数据完全相同比例的天数、周数和月份。
3.  **无数据泄漏**：由于块是非重叠的，我们避免了滑动窗口采样固有的冗余（其中 $x_t$ 会出现在 $L$ 个不同的窗口中）。

### 2.3 实现逻辑

设 $S$ 为步长参数。
*   **重叠（滑动窗口）：** $S = 1$。生成的集合对应索引 $\{0, 1, 2, \dots \}$。这会引入极度冗余（99.8% 重叠），并且如果 $N \ll T_{total}$（例如，只生成前 2 天），则会产生时间偏差。
*   **非重叠（块状）：** $S = L$。生成的集合对应索引 $\{0, L, 2L, \dots \}$。这最大化了信息增益和覆盖范围。

我们改进的采样算法通过设置 $S=L$ 来实现策略 B，确保生成的合成数据集 $\mathcal{D}_{syn}$ 是 $\mathcal{D}_{real}$ 的完整、无偏的"平行宇宙"版本。
