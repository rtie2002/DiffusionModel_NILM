# 采样重叠问题与解决方案

## 1. 问题："时间条件不起作用"
**症状**：
用户观察到生成的合成数据似乎"卡"在特定时间段（例如，仅包含 12 月或 1 月的数据），尽管模型是在全年数据集上训练的。这导致了最初的怀疑：时间条件机制（月份、日期、小时的 Sin/Cos 特征）损坏了。

**根因分析**：
问题**不在于**模型训练或条件逻辑，而在于**采样策略**。

原始的 `main.py` 采样逻辑在设置为 `ordered=True`（顺序）时，使用默认步长为 `1` 的**滑动窗口**方法。
*   **总数据点数**：约 1,200,000 分钟（约 2.4 年）。
*   **窗口大小**：512 分钟。
*   **可用滑动窗口总数**：约 1,200,000（窗口 0=[0-512]，窗口 1=[1-513]，...）。

当用户请求特定数量的样本（例如，`2500` 个窗口）来形成数据集时：
*   脚本生成索引：`0, 1, 2, ..., 2499`。
*   **时间覆盖**：这 2500 个窗口仅覆盖数据的前 `2500 + 512` 分钟（约 **2 天**）。
*   **结果**：合成数据集成功有效地重现了 2 天的数据，但自然地，月份和日期在短短 48 小时内不会改变。这造成了"时间条件"失败的错觉。

## 2. 解决方案：非重叠"展开"采样
要生成与原始数据集**在统计上一致**的合成数据集（覆盖相同的持续时间、季节和天数），采样必须是**非重叠的**。

**实现的新逻辑**：
我们引入了一种新的采样模式：**`--sampling_mode ordered_non_overlapping`**。

### 数学变化
**旧逻辑（滑动/重叠）**：
$$ Index_i = Start + i \times 1 $$
*$N$ 个样本的覆盖范围 $\approx N$ 分钟。*

**新逻辑（步长/非重叠）**：
$$ Index_i = Start + i \times WindowSize $$
*$N$ 个样本的覆盖范围 $\approx N \times 512$ 分钟。*

### 实现细节
1.  **`main.py`**：
    *   添加了 `ordered_non_overlapping` 逻辑。
    *   自动设置 `stride = dataset.window`（512）。
    *   自动计算覆盖整个文件所需的 `num_samples`：$N = \lceil \frac{TotalPoints}{WindowSize} \rceil$。

2.  **`solver.py`**：
    *   修改了 `trainer.sample()` 以接受 `stride` 参数。
    *   索引现在生成为 `[(i * stride) % dataset_size]`。

### 结果
*   **100% 覆盖**：采样器现在每步跳过 512 分钟。生成约 2500 个样本现在覆盖原始数据集的全部 120 万分钟。
*   **无冗余**：生成的窗口零重叠，消除了下游训练的数据泄漏。
*   **正确的分布**：由于真实历史中的每个时间戳都被精确地用作条件一次，因此合成数据具有与真实数据完全相同的季节性（月份）和每周（星期几）分布。

## 3. 处理 >100% 数据（例如，200%）
当用户请求原始数据大小的 **200%** 时：
1.  循环使用模运算符 `% dataset_size` 回绕数据集长度。
2.  **第 1 遍**：生成索引 $0, 512, 1024, \dots$（完整时间线，V1）。
3.  **第 2 遍**：生成索引 $0, 512, 1024, \dots$（完整时间线，V2）。
4.  **多样性**：尽管第 1 遍和第 2 遍的时间条件相同，但**随机噪声初始化**（$\epsilon \sim \mathcal{N}(0, I)$）是不同的。这导致完全相同的历史时刻产生两种不同的功率曲线变体，有效地作为强大的**数据增强**。
